<!DOCTYPE html>
<meta charset="utf-8">
<head>
  <title>From letters with Love</title>
</head>

<style>
circle {
  fill: cadetblue;
}
line {
  stroke: #ccc;
}
text {
  text-anchor: middle;
  font-family: "Helvetica Neue", Helvetica, sans-serif;
  fill: #666;
  font-size: 16px;
}
</style>

<body>
  <div id="content">
    <svg width="400" height="300">
      <g class="links"></g>
      <g class="nodes"></g>
      <g class="levels"></g>
    </svg>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.2.2/d3.min.js"></script>
  <script>
    document.write('<script src="http://' + (location.host || 'localhost').split(':')[0] +
    ':35729/livereload.js?snipver=1"></' + 'script>')
  </script>

  <script>
    var width = 400, height = 300

    var nodes = [
     {name: 'A', depth:0},
     {name: 'B', depth:1},
     {name: 'C', depth:1},
     {name: 'D', depth:2},
     {name: 'E', depth:2},
     {name: 'F', depth:3},
     {name: 'G', depth:4},
     {name: 'H', depth:5},
    ]

    var links = [
      {source: 0, target: 1},
      {source: 0, target: 2},
      {source: 0, target: 3},
      {source: 1, target: 6},
      {source: 3, target: 4},
      {source: 3, target: 7},
      {source: 4, target: 5},
      {source: 4, target: 7}
    ]

    var generateYLevelValues = d3.scaleLinear()
      .domain([0, 5])
      .range([30, height - 30])

    forceYByLevelValues = [50,100,150,200,250,300]
    var simulation = d3.forceSimulation(nodes)
      .force('collision', d3.forceCollide(20))
      .force('center', d3.forceX().x(width / 2))
      .force('levelLines', d3.forceY().y(function(d){
        return generateYLevelValues(d.depth)
      }))
      // .force('link', d3.forceLink().links(links))
      .on('tick', ticked);

    drawLevelLines()

    function updateLinks() {
      var u = d3.select('.links')
        .selectAll('line')
        .data(links)

      u.enter()
        .append('line')
        .merge(u)
        .attr('x1', function(d) {
          return d.source.x
        })
        .attr('y1', function(d) {
          return d.source.y
        })
        .attr('x2', function(d) {
          return d.target.x
        })
        .attr('y2', function(d) {
          return d.target.y
        })

      u.exit().remove()
    }

    function updateNodes() {
      var something = d3.select('body #content svg g.nodes') // svg -> g.nodes !!!
      var nodesTag = d3.select('g.nodes') // svg -> g.nodes !!!

      var groups = nodesTag.selectAll('g.groups')
        .data(nodes);

       groups.enter().append('g')
        .merge(groups)
        .attr('transform', function(d) {
          return 'translate('+d.x+','+d.y+')'
        })
        .attr('class', 'groups')

      groups.append('text')
        .attr('dy', '.35em')
        .attr('y', function(d) { return d.children ? -20 : 20; })
        .style('text-anchor', 'middle')
        .text(function(d) { return d.name + ' ' + d.depth });

      groups.append('circle')
        .attr('r', 10)
        .attr('style',function(d){
          // http://www.color-hex.com/color-palette/53835
          var color = d.type==='container'?'#b4e2f4':'#f9eeb8'
          return 'fill:'+color+'; stroke:darkgrey; stroke-width:3'
        })
        .style('cursor', 'pointer')

      groups.exit().remove()

      groups
          .call(d3.drag()
          .on('start', dragstarted)
          .on('drag', dragged)
          .on('end', dragended))

      //https://bl.ocks.org/d3noob/204d08d309d2b2903e12554b0aef6a4d
      function dragstarted(d) {
        console.log('dragged');
        d.fx = d3.event.x;
        d.fy = d3.event.y;
        d3.select(this).raise().classed('active', true);
      }

      function dragged(d) {
        d.fx = d3.event.x;
        d.fy = d3.event.y;
        d3.select(this)
          .attr('transform', function(d) {
            return 'translate(' + d3.event.x + ',' + d3.event.y + ')';
          })
        // var links = g
        // groups.selectAll('line.link')
        // update()
      }

      function dragended(d) {
        d.fx = null;
        d.fy = null;
        d3.select(this).classed('active', false);
      }

    }

    function ticked() {
      updateLinks()
      updateNodes()
    }

    function drawLevelLines() {
      for(var i=0; i<6; i++){
        let y = generateYLevelValues(i)
        var levelLine = d3.select('.levels').append('line')
        levelLine.attr('x1',0)
        levelLine.attr('y1',y)
        levelLine.attr('x2',width)
        levelLine.attr('y2',y)
        levelLine.style('stroke:1px solid grey')
      }
    }

    ticked()
  </script>
</body>
</html>
